# network config
sudo nmcli c show
sudo nmcli d show

# delete network config
typeset -i cpt=0
for bridge in prd hb0 hb1
do
    sudo nmcli c del bridge-br-$bridge
    sudo nmcli c del dummy-dummy$cpt
    sudo ip link del dummy$cpt
    let cpt=$cpt+1
done

# create network config
typeset -i cpt=0
for bridge in prd hb0 hb1
do
    sudo nmcli c add type dummy ifname dummy$cpt con-name dummy-dummy$cpt
    sudo nmcli c mod dummy-dummy$cpt ipv4.method disabled
    sudo nmcli c add type bridge ifname br-$bridge con-name bridge-br-$bridge
    sudo nmcli c mod bridge-br-$bridge bridge.stp no
    sudo nmcli c mod dummy-dummy$cpt connection.master br-$bridge connection.slave-type bridge
    sudo nmcli c mod bridge-br-$bridge ipv4.method manual ipv4.addresses 192.168.10$cpt.1/24
    sudo nmcli c up bridge-br-$bridge
    sudo nmcli c up dummy-dummy$cpt
    let cpt=$cpt+1
done


# sudo nmcli c add type ethernet ifname enp0s31f6 con-name enp0s31f6
# sudo nmcli c mod enp0s31f6 connection.master br-prd connection.slave-type bridge

# zpool create
zpool create -f data /dev/disk/by-id/wwn-0x5000c500a8f5c148 
zpool add data cache /dev/disk/by-id/nvme-eui.0025385571b178e8-part3
zpool add data log /dev/disk/by-id/nvme-eui.0025385571b178e8-part4
zfs create data/vdc
zfs set canmount=noauto data/vdc
mount -t zfs data/vdc /data
cd /data & git clone git+ssh://opensvc@www.opensvc.com/home/opensvc/vdc

# libvirt pool create
mkdir -p /data/vdc/pool
virsh pool-define-as vdc --type dir --target /data/vdc/pool
virsh pool-start vdc
virsh pool-autostart vdc

# libvirt dnsmasq domain forwarding
sudo virsh net-edit vagrant-libvirt
# add:
#  <dns>
#    <forwarder domain='vdc.opensvc.com' addr='192.168.100.9'/>
#  </dns>
sudo virsh net-destroy vagrant-libvirt
sudo virsh net-define /etc/libvirt/qemu/networks/vagrant-libvirt.xml
sudo virsh net-start vagrant-libvirt

# repos
sudo apt install yum-utils createrepo
sudo mkdir -p /data/vdc/share/repos/centos/7/{base,centosplus,extras,updates}
sudo mkdir -p /data/vdc/share/repos/epel/7
sudo mkdir -p /data/vdc/share/repos/elrepo/7
cd /data/vdc/share/repos
sudo reposync --config=/data/vdc/share/repos/yum/yum.conf --plugins --repoid=base \
  --newest-only --delete --downloadcomps --download-metadata \
  --download_path=/data/vdc/share/repos/centos/7/
sudo reposync --config=/data/vdc/share/repos/yum/yum.conf --plugins --repoid=extras \
  --newest-only --delete --downloadcomps --download-metadata \
  --download_path=/data/vdc/share/repos/centos/7/
sudo reposync --config=/data/vdc/share/repos/yum/yum.conf --plugins --repoid=updates \
  --newest-only --delete --downloadcomps --download-metadata \
  --download_path=/data/vdc/share/repos/centos/7/
sudo reposync --config=/data/vdc/share/repos/yum/yum.conf --plugins --repoid=epel \
  --newest-only --delete --downloadcomps --download-metadata \
  --download_path=/data/vdc/share/repos/epel/7/
sudo reposync --config=/data/vdc/share/repos/yum/yum.conf --plugins --repoid=elrepo \
  --newest-only --delete --downloadcomps --download-metadata \
  --download_path=/data/vdc/share/repos/elrepo/7/
sudo createrepo /data/vdc/share/repos/centos/7/base/ -g comps.xml
sudo createrepo /data/vdc/share/repos/centos/7/extras/
sudo createrepo /data/vdc/share/repos/centos/7/updates/
sudo createrepo /data/vdc/share/repos/epel/7/
sudo createrepo /data/vdc/share/repos/elrepo/7/

# provision lab vm
cd /data/vdc/build/lab
vagrant up --no-parallel

# unprovision lab vm
cd /data/vdc/build/lab
vagrant destroy

# unprovision shared disks
virsh vol-list --pool vdc | \
	grep "/data/vdc/pool/lab_cluster.*img" | \
	awk '{print $1}' | \
	xargs -n1 virsh vol-delete --pool vdc --vol


# vagrant/vbox survival guide
# ----------------------
# vagrant up --debug &> vagrant.log
# vboxmanage showvminfo vm-name
# vboxmanage list hdds      # liste les disques de la database vagrant
# vboxmanage closemedium disk eb42735a-980c-4da5-9ae4-95c5ff48b1bb --delete  # retire un disque de la database vagrant
