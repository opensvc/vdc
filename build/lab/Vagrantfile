# -*- mode: ruby -*-
# vi: set ft=ruby :
#

require 'yaml'

current_dir    = File.dirname(File.expand_path(__FILE__))
configs        = YAML.load_file("#{current_dir}/../vagrant.osvc.config.yaml")
vagrant_config = configs['configs'][configs['configs']['use']]

hosts = {
	"node1-1" => {
		"memory" => 512,
		"cluster" => "cluster-1",
                "sshexpose" => 20111
	},
	"node2-1" => {
		"memory" => 512,
		"cluster" => "cluster-1",
                "sshexpose" => 20112
	},
	"node1-2" => {
		"memory" => 512,
		"cluster" => "cluster-2",
                "sshexpose" => 20211
	},
	"node2-2" => {
		"memory" => 512,
		"cluster" => "cluster-2",
                "sshexpose" => 20212
	},
	"node1-3" => {
		"memory" => 512,
		"cluster" => "cluster-3",
                "sshexpose" => 20311
	},
	"node2-3" => {
		"memory" => 512,
		"cluster" => "cluster-3",
                "sshexpose" => 20312
	},
	"node1-4" => {
		"memory" => 512,
		"cluster" => "cluster-4",
                "sshexpose" => 20411
	},
	"node2-4" => {
		"memory" => 512,
		"cluster" => "cluster-4",
                "sshexpose" => 20412
	},
	"node1-5" => {
		"memory" => 512,
		"cluster" => "cluster-5",
                "sshexpose" => 20511
	},
	"node2-5" => {
		"memory" => 512,
		"cluster" => "cluster-5",
                "sshexpose" => 20512
	},
	"node1-6" => {
		"memory" => 512,
		"cluster" => "cluster-6",
                "sshexpose" => 20611
	},
	"node2-6" => {
		"memory" => 512,
		"cluster" => "cluster-6",
                "sshexpose" => 20612
	},
	"node1-7" => {
		"memory" => 512,
		"cluster" => "cluster-7",
                "sshexpose" => 20711
	},
	"node2-7" => {
		"memory" => 512,
		"cluster" => "cluster-7",
                "sshexpose" => 20712
	},	
	"node1-8" => {
		"memory" => 512,
		"cluster" => "cluster-8",
                "sshexpose" => 20811
	},
	"node2-8" => {
		"memory" => 512,
		"cluster" => "cluster-8",
                "sshexpose" => 20812
	},
	"node1-9" => {
		"memory" => 512,
		"cluster" => "cluster-9",
                "sshexpose" => 20911
	},
	"node2-9" => {
		"memory" => 512,
		"cluster" => "cluster-9",
                "sshexpose" => 20912
	},
	"node1-10" => {
		"memory" => 512,
		"cluster" => "cluster-10",
                "sshexpose" => 21011
	},
	"node2-10" => {
		"memory" => 512,
		"cluster" => "cluster-10",
                "sshexpose" => 21012
	},
	"node1-11" => {
		"memory" => 512,
		"cluster" => "cluster-11",
                "sshexpose" => 21111
	},
	"node2-11" => {
		"memory" => 512,
		"cluster" => "cluster-11",
                "sshexpose" => 21112
	},
	"node1-12" => {
		"memory" => 512,
		"cluster" => "cluster-12",
                "sshexpose" => 21211
	},
	"node2-12" => {
		"memory" => 512,
		"cluster" => "cluster-12",
                "sshexpose" => 21212
	},
	"node1-13" => {
		"memory" => 512,
		"cluster" => "cluster-13",
                "sshexpose" => 21311
	},
	"node2-13" => {
		"memory" => 512,
		"cluster" => "cluster-13",
                "sshexpose" => 21312
	},
	"node1-14" => {
		"memory" => 512,
		"cluster" => "cluster-14",
                "sshexpose" => 21411
	},
	"node2-14" => {
		"memory" => 512,
		"cluster" => "cluster-14",
                "sshexpose" => 21412
	},
	"node1-15" => {
		"memory" => 512,
		"cluster" => "cluster-15",
                "sshexpose" => 21511
	},
	"node2-15" => {
		"memory" => 512,
		"cluster" => "cluster-15",
                "sshexpose" => 21512
	},
	"node1-16" => {
		"memory" => 512,
		"cluster" => "cluster-16",
                "sshexpose" => 21611
	},
	"node2-16" => {
		"memory" => 512,
		"cluster" => "cluster-16",
                "sshexpose" => 21612
	},
}

Vagrant.configure("2") do |config|
        config.trigger.before [:up, :halt, :provision] do |trigger|
                trigger.run = {inline: "../common/update.etc.hosts.sh"}
        end
	config.vm.provision "ansible" do |ansible|
		ansible.playbook = "../common/playbooks/packages.yaml"
        end
        config.vm.provision "shell", path: "../common/ntp.sh"
        config.vm.provision "shell", path: "../common/net.sh"
        config.vm.provision "shell", path: "../common/yum.sh"
        config.vm.provision "shell", path: "../common/autofs.sh", env: {"VMAUTOFSROOT" => vagrant_config['vmautofsroot'], "VMAUTOFSKEY" => vagrant_config['vmautofskey']}
	config.vm.provision "shell", path: "../common/ssh.sh"
	config.vm.provision "shell", path: "../common/md.sh"
        config.vm.provision "shell", path: "../common/docker.sh"
	config.vm.provision "shell", path: "../common/lvm.sh"
	config.vm.provision "shell", path: "../common/user.sh", env: {"VAGRANTPASSWDBASE64HASH" => vagrant_config['vagrantpasswdbase64hash']}
	config.vm.provision "shell", path: "../common/alias.sh"
	config.vm.provision "shell", path: "../common/selinux.sh"
	config.vm.provision "shell", path: "../common/iscsi.sh", env: {"ISCSITGTIP" => vagrant_config['iscsitgtip']}
	config.vm.provision "shell", path: "../common/qabot.ssh.key.sh"
        config.vm.provision "shell", path: "../common/distrib.upgrade.sh"


	hosts.each do |name, desc|
		config.vm.define name do |machine|
			machine.vm.box = "bento/centos-7"
			machine.vm.hostname = "%s" % name
                        machine.vm.network "private_network", :type => 'dhcp', :name => 'vboxnet0', :adapter => 2
                        machine.vm.network "public_network", bridge: "br-prd", auto_config: false
                        machine.vm.network "public_network", bridge: "br-hb1", auto_config: false
                        machine.vm.network "public_network", bridge: "br-hb2", auto_config: false
                        machine.vm.network "forwarded_port", guest: 22, host: desc["sshexpose"], id: "ssh"
                        machine.vm.provider "virtualbox" do |v|
                                v.linked_clone = true
                                v.memory = desc["memory"]
                                v.name = "%s" % name
                                v.customize ["modifyvm", :id, "--nicpromisc2", "allow-all"]
                                v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
                                v.customize ["modifyvm", :id, "--audio", "none"]
                                #v.customize ["setproperty", "vrdeauthlibrary", "null"]
                                v.customize ["modifyvm", :id, "--vrde", "on"]
                                vrdpexpose = desc["sshexpose"] + 1000
                                v.customize ["modifyvm", :id, "--vrdeport", vrdpexpose]
                                v.customize ["modifyvm", :id, "--vrdeaddress", "0.0.0.0"]
                                #v.customize ["modifyvm", :id, "--vrdeauthtype", "external"]
                                #v.customize ["setextradata", :id, "VBoxAuthSimple/users/console", vagrant_config['vrdppasswdhash']]
			end
		end
	end
end

